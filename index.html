<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Стеганографія</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
            type="application/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
</head>
<body>
<script>


    provider = new ethers.providers.InfuraProvider('rinkeby', {
        projectId: 'eea7936a594447ac814a6e6d96e98fc1',
        // projectSecret: 'f0a0f344794d44da9156d24af396d46d'
    });

    wallet = new ethers.Wallet('52296d0ada7943a3e529442e58c178a4e1b35b828f059a31d81a33f351a78cd8', provider)

    wallet.getBalance().then(
        success => {
            console.log(ethers.utils.formatUnits(success))
        },
        error => {
            console.error(error)
        })

    contract = new ethers.Contract('0xC4B20d2555be52eDf5F32806d7328479edECB584',
        '[{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"read","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"text","type":"string"}],"name":"send","outputs":[],"stateMutability":"nonpayable","type":"function"}]',
        provider);
    contractWithSigner = contract.connect(wallet);


    async function sendText(id, text) {
        if (!id) {
            const id = Math.floor(Math.random() * 99999999)
        }
        tx = await contractWithSigner.send(id, text)
        return tx.wait().transactionHash
    }

    async function readText(id) {
        return contractWithSigner.read(id)
    }

    function getIdFromText(text) {
        const allWords = text.replace(/\s\s+/g, ' ').split(' ')

        console.log(allWords)

        let strId = ''

        for (let i = 0; i < 8; i++) {
            const l = allWords[i * 2].charAt(0).toLowerCase()
            console.log(i, numberFromLetter[l])
            strId += numberFromLetter[l]
        }

        console.log(Number(strId))
        return Number(strId)
    }

    async function decryptText() {
        const enc = document.getElementById('encrypt').value

        const id = getIdFromText(enc)

        document.getElementById('decrypt').value = await readText(id)
    }

    async function encryptText() {
        const msg = document.getElementById('message').value
        const key = document.getElementById('keytext').value

        const id = getIdFromText(key)

        const testExists = await readText(id)
        if (testExists && testExists.length > 0) {
            console.error('this ID in use', id, testExists)
            alert('ID вже використовується. Змініть слова на початку ключового тексту')
        }

        const result = await sendText(id, msg)
        console.log(result)
        window.location = 'https://rinkeby.etherscan.io/tx/result'
    }

</script>

<div class="container">
    <h1>Отримати повідомлення</h1>
    <p>Вставьте сюди текст який містить стеганографічне послання і натиснить кнопку "Розшифрувати"</p>
    <textarea id="encrypt"></textarea><br>
    <button onclick="decryptText()">Розшифрувати</button>
    <br>
    <p>Результат:</p>
    <textarea id="decrypt"></textarea>
</div>
<hr>
<div class="container">
    <h1>Зашифрувати повідомлення</h1>
    <p>Вставьте сюди текст який містить секретне послання </p>
    <textarea id="message"></textarea><br>
    <p></p>
    <p>Вставьте сюди текст який буде опубліковано як ключ і натиснить кнопку "Зашифрувати"</p>
    <textarea id="keytext"></textarea><br>
    <button onclick="encryptText()">Зашифрувати</button>
    <br>
</div>

<div class="container">
    <h1>
        <a href="https://docs.google.com/document/d/1PeOvcXvNsrsfINYnZOZniUGKNTt0ufcjiAsbbUWcPao/edit?usp=sharing">Як це
            працює</a>
    </h1>
</div>

<script>
    const numberFromLetter = {
        'а': 1,
        'б': 0,
        'в': 6,
        'г': 0,
        'ґ': 7,
        'д': 6,
        'е': 5,
        'є': 9,
        'ж': 4,
        'з': 2,
        'и': 3,
        'і': 7,
        'ї': 9,
        'й': 2,
        'к': 9,
        'л': 8,
        'м': 5,
        'н': 2,
        'о': 0,
        'п': 4,
        'р': 8,
        'с': 9,
        'т': 4,
        'у': 7,
        'ф': 8,
        'х': 3,
        'ц': 7,
        'ч': 1,
        'ш': 6,
        'щ': 8,
        'ь': 1,
        'ю': 5,
        'я': 3,
        'a': 2,
        'b': 0,
        'c': 8,
        'd': 9,
        'e': 0,
        'f': 4,
        'g': 3,
        'h': 7,
        'i': 4,
        'j': 2,
        'k': 1,
        'l': 9,
        'm': 6,
        'n': 5,
        'o': 3,
        'p': 1,
        'q': 4,
        'r': 8,
        's': 6,
        't': 1,
        'u': 7,
        'v': 0,
        'w': 5,
        'x': 3,
        'y': 2,
        'z': 5,
        '0': 0,
        '1': 1,
        '2': 2,
        '3': 3,
        '4': 4,
        '5': 5,
        '6': 6,
        '7': 7,
        '8': 8,
        '9': 9
    }

    lettersFromNumber = {
        0: ['0', 'о', 'б', 'г', 'e', 'b', 'v'],
        1: ['1', 'а', 'ь', 'ч', 't', 'p', 'k'],
        2: ['2', 'н', 'з', 'й', 'a', 'y', 'j'],
        3: ['3', 'и', 'я', 'х', 'o', 'g', 'x'],
        4: ['4', 'т', 'п', 'ж', 'i', 'f', 'q'],
        5: ['5', 'е', 'м', 'ю', 'n', 'w', 'z'],
        6: ['6', 'в', 'д', 'ш', 's', 'm'],
        7: ['7', 'і', 'у', 'ц', 'ґ', 'h', 'u'],
        8: ['8', 'р', 'л', 'щ', 'ф', 'r', 'c'],
        9: ['9', 'с', 'к', 'є', 'ї', 'd', 'l']
    }

    function testLetters() {

        for (let i = 0; i < 10; i++) {
            const arr = lettersFromNumber[i]
            for (let j = 0; j < arr.length; j++) {
                const key = arr[j]
                if (numberFromLetter[key] !== i) {
                    console.error(i, key)
                } else {
                    console.log(i, key)
                }
            }
        }
    }

</script>
</body>
</html>
